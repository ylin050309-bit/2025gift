<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ New Year Gift</title>
  <style>
    :root{
      /* ===== New Year Red + Gold theme ===== */
      --bg1:#12040A;
      --bg2:#23030C;
      --card:#1a0611cc;
      --line:#ffffff24;
      --text:#fff3f4;
      --muted:#f2cfd2;

      --accent:#ff3b3b;   /* red */
      --accent2:#ffd36e;  /* gold */

      --glow: 0 0 16px rgba(255,59,59,.35);
      --glow2: 0 0 16px rgba(255,211,110,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(255,59,59,.20) 0%, transparent 55%),
        radial-gradient(900px 600px at 92% 30%, rgba(255,211,110,.16) 0%, transparent 60%),
        radial-gradient(900px 600px at 55% 85%, rgba(255,77,166,.10) 0%, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    canvas#fx{
      position:fixed; inset:0; width:100%; height:100%;
      pointer-events:none; z-index:1;
    }
    .wrap{
      position:relative; z-index:2;
      max-width:920px; margin:0 auto; padding:40px 18px 64px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; gap:10px; align-items:center;
      border:1px solid var(--line); border-radius:999px;
      padding:8px 12px; background:#ffffff0f; backdrop-filter: blur(10px);
      font-size:14px; color:var(--muted);
    }
    .badgeBtn{
      display:inline-flex; gap:10px; align-items:center;
      border:1px solid var(--line); border-radius:999px;
      padding:8px 12px; background:#ffffff10; backdrop-filter: blur(10px);
      font-size:14px; color:var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .badgeBtn:hover{ background:#ffffff16; border-color:#ffffff33; }
    .badgeBtn:active{ transform: translateY(1px); }
    .badgeBtn.on{
      border-color: rgba(255,59,59,.45);
      box-shadow: var(--glow), 0 0 0 1px rgba(255,59,59,.20) inset;
      background: linear-gradient(90deg, rgba(255,59,59,.22), rgba(255,211,110,.18));
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--accent), rgba(255,59,59,0));
      box-shadow: var(--glow);
    }
    .card{
      border:1px solid var(--line);
      border-radius:22px;
      background: linear-gradient(135deg,#ffffff14,#ffffff06);
      box-shadow: 0 20px 60px #00000066;
      overflow:hidden;
    }
    .hero{
      padding:28px 22px 18px;
      background:
        radial-gradient(900px 260px at 12% 10%, rgba(255,59,59,.18), transparent 60%),
        radial-gradient(900px 260px at 88% 10%, rgba(255,211,110,.14), transparent 60%);
      border-bottom:1px solid var(--line);
    }
    h1{
      margin:0;
      font-size:28px;
      letter-spacing:.5px;
      line-height:1.2;
    }
    .sub{
      margin:10px 0 0;
      color:var(--muted);
      font-size:15px;
      line-height:1.7;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .8fr;
      padding:18px 22px 22px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
      padding:16px;
    }
    .kpi{
      display:grid; grid-template-columns: repeat(4,1fr);
      gap:10px; margin-top:10px;
    }
    @media (max-width: 520px){
      .kpi{grid-template-columns: repeat(2,1fr)}
    }
    .k{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 10px;
      text-align:center;
      background:#ffffff08;
    }
    .k b{display:block; font-size:22px}
    .k span{display:block; margin-top:6px; color:var(--muted); font-size:12px}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button{
      border:1px solid var(--line);
      background:#ffffff10;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:14px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{background:#ffffff16}
    button:active{transform: translateY(1px)}
    .primary{
      border-color: rgba(255,59,59,.5);
      background: linear-gradient(90deg, rgba(255,59,59,.24), rgba(255,211,110,.18));
      box-shadow: var(--glow), 0 0 0 1px rgba(255,59,59,.18) inset;
    }
    .msg{
      margin:0;
      white-space:pre-wrap;
      line-height:1.75;
      font-size:15px;
    }
    .type{
      display:inline-block;
      border-right: 2px solid #ffffff88;
      padding-right:2px;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 50%{border-right-color: transparent} }
    .small{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.6}
    .footer{
      padding:14px 22px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      color:var(--muted); font-size:12px;
    }
    a{color:var(--accent2)}
    .hidden{display:none}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 12px; border-radius:14px;
      background:#000000aa; color:#fff; font-size:13px;
      border:1px solid #ffffff2a; z-index:50;
      opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    .toast.show{opacity:1}

    @media (prefers-reduced-motion: reduce){
      canvas#fx{display:none}
      .type{animation:none; border-right:none}
      button{transition:none}
    }

    /* ===== Password lock UI ===== */
    button:disabled{opacity:.55; cursor:not-allowed}
    .lock{
      position:fixed; inset:0; z-index:60;
      display:flex; align-items:center; justify-content:center;
      padding:20px;
      background:
        radial-gradient(800px 500px at 50% 20%, rgba(255,211,110,.10), transparent 60%),
        rgba(0,0,0,.74);
      backdrop-filter: blur(10px);
    }
    .lockCard{
      width:min(520px, 100%);
      border:1px solid #ffffff2a;
      border-radius:22px;
      padding:18px 16px 14px;
      background: linear-gradient(135deg, rgba(26,6,17,.95), rgba(16,3,10,.95));
      box-shadow: 0 30px 90px #00000088;
    }
    .lockTitle{font-size:18px; margin:0 0 6px}
    .lockSub{margin:0 0 14px; color:var(--muted); font-size:13px; line-height:1.6}
    .lockRow{display:flex; gap:10px}
    .lockRow input{
      flex:1; padding:10px 12px; border-radius:14px;
      border:1px solid #ffffff2a; background:#ffffff0a;
      color:var(--text); outline:none;
    }
    .lockRow input:focus{border-color: rgba(255,59,59,.55); box-shadow: var(--glow); }
    .lockErr{margin:10px 0 0; color:#ffb2d8; font-size:12px; min-height:16px}

    /* ===== Modal (Gift / Video) ===== */
    .modal{
      position:fixed; inset:0; z-index:70;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
    }
    .modal.hidden{display:none}
    .modalCard{
      width:min(820px, 100%);
      border:1px solid #ffffff2a;
      border-radius:22px;
      background: linear-gradient(135deg, rgba(26,6,17,.96), rgba(16,3,10,.96));
      box-shadow: 0 30px 100px #00000099;
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border-bottom:1px solid #ffffff1f;
    }
    .modalTitle{
      font-size:15px; color:var(--text);
      display:flex; align-items:center; gap:10px;
    }
    .closeBtn{
      border:1px solid #ffffff2a;
      background:#ffffff10;
      color:#fff;
      padding:8px 10px;
      border-radius:14px;
      cursor:pointer;
    }
    .modalBody{ padding:14px 16px 18px; }
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 720px){
      .imgGrid{grid-template-columns:1fr}
    }
    .imgCard{
      border:1px solid #ffffff22;
      border-radius:18px;
      overflow:hidden;
      background:#ffffff08;
    }
    .imgCard img{
      width:100%;
      height:360px;
      object-fit:cover;
      display:block;
    }
    @media (max-width: 720px){
      .imgCard img{height:320px}
    }
    .imgCap{
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid #ffffff18;
    }
    .modalHint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    /* ===== Video modal ===== */
    .videoWrap{
      border:1px solid #ffffff22;
      border-radius:18px;
      overflow:hidden;
      background:#000;
    }
    .videoWrap video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .videoNote{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    /* ===== Unlock celebration overlay ===== */
    .celebrate{
      position:fixed; inset:0; z-index:65;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
      opacity:0;
      transition: opacity .18s ease;
    }
    .celebrate.show{opacity:1}
    .celebrateCard{
      border:1px solid #ffffff2a;
      border-radius:22px;
      background: linear-gradient(135deg, rgba(26,6,17,.96), rgba(16,3,10,.96));
      box-shadow: 0 30px 90px #00000099;
      padding:16px 18px;
      text-align:center;
      max-width:min(520px, 92vw);
    }
    .celebrateTitle{
      font-size:26px;
      letter-spacing:.6px;
      margin:0;
    }
    .celebrateSub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .confetti{
      position:absolute; inset:0;
      overflow:hidden;
      pointer-events:none;
    }
    .confetti i{
      position:absolute;
      top:-16px;
      width:10px;
      height:16px;
      border-radius:3px;
      opacity:.95;
      background: var(--c, var(--accent));
      transform: translate3d(0,-10px,0) rotate(0deg);
      animation: fall var(--dur, 1.5s) linear var(--delay, 0s) forwards;
    }
    @keyframes fall{
      0%   { transform: translate3d(var(--dx,0px), -20px, 0) rotate(0deg);   opacity:1; }
      100% { transform: translate3d(var(--dx,0px), calc(100vh + 40px), 0) rotate(720deg); opacity:0; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <!-- âœ… Background Music -->
  <audio id="bgm" src="assets/audio/bgm.mp3" loop preload="auto"></audio>

  <div class="wrap">
    <div class="top">
      <div class="badge"><span class="dot"></span><span id="meta">Loadingâ€¦</span></div>
      <div class="badge">ğŸ§§ æ–°å¹´å¿«ä¹ï¼</div>
      <button class="badgeBtn" id="musicToggle" type="button">ğŸ”‡ éŸ³ä¹ï¼šå…³</button>
    </div>

    <div class="card">
      <div class="hero">
        <h1 id="title">ç»™ <span id="toName">ä½ </span> çš„è·¨å¹´ç¤¼ç‰©</h1>
        <p class="sub" id="subText">
          <br/>
         ğŸ ç¤¼ç‰©ç…§ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°â€œæˆ‘ä»¬ä¿©â€çš„ç…§ç‰‡ï¼›ç‚¹å‡» ğŸ ç°åœ¨æ‹†ç¤¼ç‰©ï¼Œä¼šæ’­æ”¾è§†é¢‘ã€‚
        </p>
      </div>

      <div class="grid">
        <div class="panel">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
            <div>
              <div style="color:var(--muted);font-size:13px">è·ç¦»æ–°å¹´çš„æ—¶é—´</div>
              <div class="kpi" aria-label="countdown">
                <div class="k"><b id="dd">--</b><span>å¤©</span></div>
                <div class="k"><b id="hh">--</b><span>å°æ—¶</span></div>
                <div class="k"><b id="mm">--</b><span>åˆ†é’Ÿ</span></div>
                <div class="k"><b id="ss">--</b><span>ç§’</span></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted);font-size:12px">From</div>
              <div style="font-size:14px;margin-top:6px" id="fromName">Steven</div>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="openBtn">ğŸ ç°åœ¨æ‹†ç¤¼ç‰©</button>
            <button id="newWishBtn">âœ¨ æ¢ä¸€å¥ç¥ç¦</button>
            <button id="giftBtn">ğŸ ç¤¼ç‰©ç…§ç‰‡</button>
            <button id="copyBtn">ğŸ”— å¤åˆ¶é“¾æ¥</button>
            <button id="boomBtn">ğŸ† æ”¾ä¸€æ¬¡çƒŸèŠ±</button>
          </div>

          <div class="small" id="smallNote">
            å¦‚æœéŸ³ä¹æ²¡æœ‰è‡ªåŠ¨æ’­æ”¾ï¼šç‚¹ä¸€ä¸‹é¡µé¢æˆ–å³ä¸Šè§’â€œéŸ³ä¹â€å³å¯å¼€å¯ã€‚
          </div>
        </div>

        <div class="panel">
          <div style="color:var(--muted);font-size:13px;margin-bottom:10px">ç¤¼ç‰©å†…å®¹</div>
          <p class="msg" id="msg">
            <span id="typed" class="type">ğŸ”’ è¾“å…¥ç”Ÿæ—¥è§£é”åå¯è§</span>
          </p>
          <div id="extra" class="hidden" style="margin-top:12px; border-top:1px solid var(--line); padding-top:12px;">
            <div style="color:var(--muted);font-size:12px">ğŸ¯ æ–°å¹´</div>
            <ul style="margin:8px 0 0; padding-left:18px; line-height:1.7;">
              <li>é€‰ä¸€ä¸ªä½ æƒ³åšæŒçš„ä¹ æƒ¯ï¼ŒåšæŒ 7 å¤©ã€‚</li>
              <li>ç»™è‡ªå·±å†™ä¸€å¥â€œæ˜å¹´æˆ‘å¸Œæœ›ä½ ___â€ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Made By Yuxuan Lin</div>
      </div>
    </div>
  </div>

  <!-- Password Lock -->
  <div class="lock" id="lock">
    <div class="lockCard">
      <p class="lockTitle">ğŸ”’ è¾“å…¥ä½ çš„ç”Ÿæ—¥æ¥æ‹†ç¤¼ç‰©</p>
      <p class="lockSub" id="lockHint">è¯·è¾“å…¥ 8 ä½æ•°å­—ï¼šYYYYMMDDï¼ˆä¾‹å¦‚ 20050309ï¼‰</p>

      <div class="lockRow">
        <input
          id="passInput"
          type="password"
          inputmode="numeric"
          autocomplete="off"
          placeholder="YYYYMMDD"
          maxlength="8"
          pattern="\d{8}"
        />
        <button class="primary" id="unlockBtn">è§£é”</button>
      </div>
      <div class="lockErr" id="lockErr"></div>
    </div>
  </div>

  <!-- Unlock Celebration -->
  <div class="celebrate" id="celebrate">
    <div class="confetti" id="confetti"></div>
    <div class="celebrateCard">
      <p class="celebrateTitle" id="celebrateTitle">ğŸ‰ æ–°å¹´å¿«ä¹</p>
      <p class="celebrateSub" id="celebrateSub">è§£é”æˆåŠŸ</p>
    </div>
  </div>

  <!-- Gift Photo Modal -->
  <div class="modal hidden" id="giftModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="giftModalTitle">
      <div class="modalHead">
        <div class="modalTitle" id="giftModalTitle">ğŸ ç¤¼ç‰©ç…§ç‰‡</div>
        <button class="closeBtn" id="closeGiftBtn">å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="imgGrid" id="giftImgGrid"></div>
        <div class="modalHint" id="giftHint"></div>
      </div>
    </div>
  </div>

  <!-- Video Gift Modal -->
  <div class="modal hidden" id="videoModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="videoModalTitle">
      <div class="modalHead">
        <div class="modalTitle" id="videoModalTitle">ğŸ¥ è§†é¢‘ç¤¼ç‰©</div>
        <button class="closeBtn" id="closeVideoBtn">å…³é—­</button>
      </div>
      <div class="modalBody">
        <div class="videoWrap">
          <video id="giftVideo" controls playsinline preload="metadata"></video>
        </div>
        <div class="videoNote" id="videoNote">
          å¦‚æœä½ çš„è§†é¢‘æ— æ³•è‡ªåŠ¨æ’­æ”¾ï¼šç‚¹ä¸€ä¸‹æ’­æ”¾é”®å³å¯ï¼ˆiPhone æœ‰æ—¶ä¼šé™åˆ¶è‡ªåŠ¨æ’­æ”¾å£°éŸ³ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å¤åˆ¶</div>

<script>
/** ----------------------------
 * URL params:
 *   ?from=Name (optional)
 *   ?k=personKey (optional: ä¸“å±é“¾æ¥æ¨¡å¼)
 * ---------------------------- */
const qs = new URLSearchParams(location.search);
const from = (qs.get("from") || "Steven").trim().slice(0, 24);
document.getElementById("fromName").textContent = from;

// DOM refs
const typedEl = document.getElementById("typed");
const openBtn = document.getElementById("openBtn");
const newWishBtn = document.getElementById("newWishBtn");
const giftBtn = document.getElementById("giftBtn");
const copyBtn = document.getElementById("copyBtn");
const boomBtn = document.getElementById("boomBtn");
const dd = document.getElementById("dd");
const hh = document.getElementById("hh");
const mm = document.getElementById("mm");
const ss = document.getElementById("ss");

function pad(n){ return String(n).padStart(2,"0"); }

/** ----------------------------
 * Toast
 * ---------------------------- */
const toast = document.getElementById("toast");
function showToast(txt){
  toast.textContent = txt;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 900);
}

/** ----------------------------
 * âœ… Background Music (NOæç¤ºå±‚)
 * é€»è¾‘ï¼š
 * - load æ—¶å°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
 * - è‹¥å¤±è´¥ï¼šç­‰å¾…ç”¨æˆ·ç¬¬ä¸€æ¬¡äº¤äº’(pointerdown/keydown)åè‡ªåŠ¨æ’­æ”¾
 * - ç”¨æˆ·æ‰‹åŠ¨å…³æ‰åï¼Œä¸å†è‡ªåŠ¨å¼€å¯
 * ---------------------------- */
const bgm = document.getElementById("bgm");
const musicToggle = document.getElementById("musicToggle");

let musicOn = false;
let userOverride = false; // ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ“ä½œè¿‡ï¼ˆæ“ä½œè¿‡å°±ä¸å†è‡ªåŠ¨å¼€ï¼‰
bgm.volume = 0.75;

function setMusicUI(on){
  musicOn = !!on;
  musicToggle.textContent = musicOn ? "ğŸµ éŸ³ä¹ï¼šå¼€" : "ğŸ”‡ éŸ³ä¹ï¼šå…³";
  musicToggle.classList.toggle("on", musicOn);
}

async function playMusic(){
  try{
    await bgm.play();
    setMusicUI(true);
    return true;
  }catch(e){
    setMusicUI(false);
    return false;
  }
}
function pauseMusic(){
  bgm.pause();
  setMusicUI(false);
}

musicToggle.addEventListener("click", async ()=>{
  userOverride = true;
  if (musicOn) {
    pauseMusic();
  } else {
    const ok = await playMusic();
    if (!ok) showToast("éŸ³ä¹æ— æ³•æ’­æ”¾ï¼šè¯·æ£€æŸ¥éŸ³é¢‘è·¯å¾„æˆ–æµè§ˆå™¨è®¾ç½®");
  }
});

function waitForUserGestureOnce(){
  const unlockAudioOnce = async () => {
    if (userOverride || musicOn) return;
    await playMusic();
  };
  document.addEventListener("pointerdown", unlockAudioOnce, { once:true });
  document.addEventListener("keydown", unlockAudioOnce, { once:true });
}

window.addEventListener("load", async ()=>{
  setTimeout(async ()=>{
    if (userOverride) return;
    const ok = await playMusic();
    if (!ok) waitForUserGestureOnce();
  }, 250);
});

/** ----------------------------
 * âœ… æ—¶åŒºè§„åˆ™ï¼šCiCi + å“¥ = å¢¨å°”æœ¬ï¼Œå…¶å®ƒ = åŒ—äº¬
 * ç›®æ ‡ï¼šæ”¶ç¤¼äººå½“åœ° 2026-01-01 00:00 æ‰å¼€æ”¾è§†é¢‘/æ˜¾ç¤ºæ–°å¹´æ–‡æ¡ˆ
 * ---------------------------- */
const GIFT_YEAR = 2026;
const TZ_BJ  = "Asia/Shanghai";
const TZ_MEL = "Australia/Melbourne";

function tzLabel(tz){
  return tz === TZ_MEL ? "å¢¨å°”æœ¬æ—¶é—´" : "åŒ—äº¬æ—¶é—´";
}
function formatInTZ(date, tz){
  return new Intl.DateTimeFormat("zh-CN",{
    timeZone: tz,
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hour12:false
  }).format(date);
}
function getTzParts(date, tz){
  const parts = new Intl.DateTimeFormat("en-US",{
    timeZone: tz,
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hour12:false
  }).formatToParts(date);
  const map = {};
  for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;
  return {
    year: +map.year,
    month: +map.month,
    day: +map.day,
    hour: +map.hour,
    minute: +map.minute,
    second: +map.second
  };
}
// æŠŠ â€œæŸæ—¶åŒºçš„æœ¬åœ°æ—¶é—´â€ -> epoch(ms)
function tzLocalToEpoch(year, month1to12, day, hour, minute, second, tz){
  let guess = Date.UTC(year, month1to12 - 1, day, hour, minute, second);
  for (let i=0;i<3;i++){
    const p = getTzParts(new Date(guess), tz);
    const gotUTC  = Date.UTC(p.year, p.month - 1, p.day, p.hour, p.minute, p.second);
    const wantUTC = Date.UTC(year, month1to12 - 1, day, hour, minute, second);
    const diff = wantUTC - gotUTC;
    guess += diff;
    if (Math.abs(diff) < 1000) break;
  }
  return guess;
}
function formatHMS(ms){
  const s = Math.max(0, Math.ceil(ms / 1000));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

const OPEN_BTN_TEXT = openBtn.textContent;
const baseSmallNoteHTML = document.getElementById("smallNote").innerHTML;

let activeTZ = TZ_BJ;
let openAtEpoch = tzLocalToEpoch(GIFT_YEAR, 1, 1, 0, 0, 0, activeTZ);
let reachedNewYear = false;

function updateMetaAndNote(){
  const nowStr = formatInTZ(new Date(), activeTZ);
  const targetStr = formatInTZ(new Date(openAtEpoch), activeTZ);
  document.getElementById("meta").textContent =
    `ç°åœ¨æ˜¯ ${nowStr} Â· ç›®æ ‡ï¼š${targetStr}ï¼ˆ${tzLabel(activeTZ)}ï¼‰`;

  document.getElementById("smallNote").innerHTML =
    baseSmallNoteHTML + `<br/>â° è§†é¢‘å¼€æ”¾ï¼š${GIFT_YEAR}å¹´1æœˆ1æ—¥ 00:00ï¼ˆ${tzLabel(activeTZ)}ï¼‰`;
}
function setActiveTZ(tz){
  activeTZ = tz || TZ_BJ;
  openAtEpoch = tzLocalToEpoch(GIFT_YEAR, 1, 1, 0, 0, 0, activeTZ);
  reachedNewYear = false;
  updateMetaAndNote();
}
function updateVideoGate(isUnlocked){
  if (!isUnlocked){
    openBtn.disabled = true;
    openBtn.textContent = OPEN_BTN_TEXT;
    return;
  }
  const remain = openAtEpoch - Date.now();
  if (remain > 0){
    openBtn.disabled = true;
    openBtn.textContent = `â³ è¿˜å‰© ${formatHMS(remain)} æ‰èƒ½æ‹†ç¤¼ç‰©`;
  } else {
    openBtn.disabled = false;
    openBtn.textContent = OPEN_BTN_TEXT;
  }
}

/** ----------------------------
 * Fireworks (åçº¢é‡‘è‰²)
 * ---------------------------- */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d");
let W=0,H=0, DPR=1;

function resize(){
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = canvas.width = Math.floor(innerWidth * DPR);
  H = canvas.height = Math.floor(innerHeight * DPR);
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
}
addEventListener("resize", resize);
resize();

const particles = [];
function rand(a,b){ return a + Math.random()*(b-a); }

// çº¢/é‡‘ hue åŒºé—´ï¼šçº¢(350-20), é‡‘(35-55), ç²‰(320-340)
function pickHue(){
  const r = Math.random();
  if (r < 0.55) return rand(350, 360); // red deep
  if (r < 0.75) return rand(0, 20);    // red bright
  if (r < 0.92) return rand(35, 55);   // gold
  return rand(320, 340);              // pink
}

function launch(x, y){
  const count = Math.floor(rand(60, 110));
  for(let i=0;i<count;i++){
    const ang = rand(0, Math.PI*2);
    const spd = rand(1.0, 5.2) * DPR;
    particles.push({
      x, y,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      life: rand(40, 90),
      age: 0,
      hue: pickHue()
    });
  }
}
function burst(times=5){
  for(let i=0;i<times;i++){
    const x = rand(W*0.15, W*0.85);
    const y = rand(H*0.15, H*0.55);
    launch(x,y);
  }
}
function step(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.fillRect(0,0,W,H);

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.age++;
    const t = p.age / p.life;
    p.vx *= 0.988;
    p.vy = p.vy*0.988 + 0.03*DPR;
    p.x += p.vx;
    p.y += p.vy;

    const alpha = Math.max(0, 1 - t);
    ctx.beginPath();
    ctx.fillStyle = `hsla(${p.hue},100%,70%,${alpha})`;
    ctx.arc(p.x, p.y, Math.max(1.0, 2.0*(1-t))*DPR, 0, Math.PI*2);
    ctx.fill();

    if(p.age >= p.life) particles.splice(i,1);
  }
  requestAnimationFrame(step);
}
step();

/** ----------------------------
 * âœ… æ¯ä¸ªäººç‹¬ç«‹å†…å®¹ + ç¤¼ç‰©å›¾ç‰‡ + ä¸“å±è§†é¢‘ + æ—¶åŒº
 * ---------------------------- */
const PEOPLE_BY_BDAY = {
  "20050309": {
    name: "Steven",
    tz: TZ_BJ,
    video: "assets/video/steven.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— Stevenï¼‰",
      hint: "æŠŠå›¾ç‰‡æ”¾åˆ° assets/img/ ä¸‹ï¼Œç„¶åæ”¹è·¯å¾„å³å¯ã€‚",
      images: [{ src: "assets/img/steven.jpg", caption: "ä½ ï¼ˆStevenï¼‰" }]
    },
    wishes: [
      (n,y,f)=>`ğŸ ${n}ï¼Œ${y} é€ä½ ä¸€å¥æœ€é‡è¦çš„ï¼š\n\nåˆ«æŠŠæ‰€æœ‰äº‹éƒ½ä¸€ä¸ªäººæ‰›ã€‚\nä½ å¯ä»¥å¼ºï¼Œä½†ä¹Ÿå€¼å¾—è¢«ç…§é¡¾ã€‚\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œ${y} æƒ³é€ä½ ä¸€ç§â€œæ¾å¼›â€ï¼š\n\næŠŠç„¦è™‘äº¤ç»™è¡ŒåŠ¨\næŠŠç›®æ ‡æ‹†æˆä»Šå¤©\næŠŠè‡ªå·±å½“æˆé˜Ÿå‹\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æŒ‡ä»¤å·²ä¸‹å‘ï¼š\n\nif (ä½ å…ˆç…§é¡¾å¥½è‡ªå·±) {\n  å¥½è¿++; \n}\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ç”Ÿæ´»æœ‰å…‰\n- ä»£ç é¡ºæ»‘\n- ç¡çœ å®‰ç¨³\n- å¿ƒé‡Œæ›´æ¾ä¸€ç‚¹\n\nâ€”â€” ${f}`
  },
  "20040210": {
    name: "CiCi",
    tz: TZ_MEL,
    video: "assets/video/cici.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— CiCiï¼‰",
      images: [{ src: "assets/img/cici.jpeg", caption: "Us" }]
    },
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç»™ä½ ä¸‰å¥â€œæ”¾å¿ƒâ€ï¼š\n\næ”¾å¿ƒå»å°è¯•\næ”¾å¿ƒå»å‘å…‰\næ”¾å¿ƒå»è¢«çˆ±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`âœ¨ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\né‡åˆ°å¥½äºº\nåšæˆå¥½äº‹\nå¾—åˆ°å¥½æ¶ˆæ¯\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- äº‹äº‹é¡ºæ„\n- å¥½è¿å¸¸åœ¨\n- å¼€å¿ƒæ›´ä¹…\n\nâ€”â€” ${f}`
  },
  "20040611": {
    name: "Manda",
    tz: TZ_BJ,
    video: "assets/video/manda.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— Mandaï¼‰",
      images: [{ src: "assets/img/manda.jpeg", caption: "Us" }]
    },
    wishes: [
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næŠŠçƒ­çˆ±å˜æˆä½œå“\næŠŠåŠªåŠ›å˜æˆç»“æœ\næŠŠæ¸©æŸ”ç•™ç»™è‡ªå·±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œ${y} é€ä½ ä¸€ä¸ªç¥ç¦ï¼š\n\nä½ å€¼å¾—è¢«è®¤çœŸå¯¹å¾…ã€‚\næ¯ä¸€æ­¥éƒ½ç®—æ•°ã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- å¹³å®‰å–œä¹\n- å¿ƒæƒ³äº‹æˆ\n\nâ€”â€” ${f}`
  },
  "20040510": {
    name: "Michelle",
    tz: TZ_BJ,
    video: "assets/video/michelle.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— Michelleï¼‰",
      images: [{ src: "assets/img/michelle.jpeg", caption: "Us" }]
    },
    wishes: [
      (n,y,f)=>`âœ¨ ${n}ï¼Œ${y} é€ä½ ä¸‰ä¸ªâ€œå…è®¸â€ï¼š\n\nå…è®¸è‡ªå·±æ…¢ä¸€ç‚¹\nå…è®¸å¶å°”ä¸å®Œç¾\nå…è®¸è¢«çˆ±ã€è¢«æ”¯æŒ\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næ›´æ¸…é†’ï¼Œä¹Ÿæ›´æŸ”è½¯\næ›´åšå®šï¼Œä¹Ÿæ›´è½»æ¾\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- æ¸©æŸ”åšå®š\n- å¥½è¿åŠ å€\n\nâ€”â€” ${f}`
  },
  "20030717": {
    name: "å“¥",
    tz: TZ_MEL,
    video: "assets/video/ge.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— å“¥ï¼‰",
      images: [{ src: "assets/img/ge.jpeg", caption: "Us" }]
    },
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥ä½ ï¼š\n\né¡ºé£é¡ºæ°´\nå‘è´¢å‘ç¦ï¼ˆä¹Ÿåˆ«å¤ªç´¯ï¼‰\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\nå°‘ä¸€ç‚¹çƒ¦å¿ƒäº‹\nå¤šä¸€ç‚¹å¥½æ¶ˆæ¯\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- äº‹ä¸šé¡ºåˆ©\n- å®¶é‡Œå¹³å®‰\n\nâ€”â€” ${f}`
  },
  "20041105": {
    name: "æ¨æ—­",
    tz: TZ_BJ,
    video: "assets/video/yangxu.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— æ¨æ—­ï¼‰",
      images: [{ src: "assets/img/yangxu.jpeg", caption: "æˆ‘ä»¬" }]
    },
    wishes: [
      (n,y,f)=>`âœ¨ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\nä¸€ç›´æœ‰åº•æ°”\nä¸€ç›´æœ‰é€‰æ‹©\nä¸€ç›´æœ‰çƒ­çˆ±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æŒ‡ä»¤ï¼š\n\nä¿æŒä½ çš„èŠ‚å¥ã€‚\nä½ ä¼šè¶Šèµ°è¶Šç¨³ã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ä¸€è·¯å¼€æŒ‚\n- å¿ƒæƒ…è½»æ¾\n\nâ€”â€” ${f}`
  },
  "19800806": {
    name: "çˆ¸",
    tz: TZ_BJ,
    video: "assets/video/dad.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— çˆ¸ï¼‰",
      images: [{ src: "assets/img/dad.jpeg", caption: "çˆ¸" }]
    },
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥æ‚¨ï¼š\n\nèº«ä½“å¥åº·\näº‹äº‹é¡ºå¿ƒ\nå¤©å¤©å¼€å¿ƒ\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿æ‚¨ ${y}ï¼š\n\nå°‘æ“å¿ƒï¼Œå¤šä¼‘æ¯\nå¹³å¹³å®‰å®‰ï¼Œé¡ºé¡ºåˆ©åˆ©\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿æ‚¨åœ¨ ${y}ï¼š\n- å¹³å®‰å¥åº·\n- ç¦æ°”æ»¡æ»¡\n\nâ€”â€” ${f}`
  },
  "19791120": {
    name: "å¦ˆ",
    tz: TZ_BJ,
    video: "assets/video/mom.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— å¦ˆï¼‰",
      images: [{ src: "assets/img/mom.jpeg", caption: "å¦ˆ" }]
    },
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥æ‚¨ï¼š\n\nèº«ä½“å¥åº·\nç¬‘å£å¸¸å¼€\nä¸‡äº‹å¦‚æ„\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿æ‚¨ ${y}ï¼š\n\nå°‘çƒ¦æ¼ï¼Œå¤šå¼€å¿ƒ\næ¯å¤©éƒ½è½»è½»æ¾æ¾\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿æ‚¨åœ¨ ${y}ï¼š\n- å¥åº·å¹³å®‰\n- å¼€å¼€å¿ƒå¿ƒ\n\nâ€”â€” ${f}`
  },
  "20050401": {
    name: "å¤ä»å®‡",
    tz: TZ_BJ,
    video: "assets/video/xiarenyu.mp4",
    gift: {
      title: "ğŸ æˆ‘ä»¬çš„ç…§ç‰‡ï¼ˆSteven Ã— å¤ä»å®‡ï¼‰",
      images: [{ src: "assets/img/xiarenyu.jpg", caption: "ä½ ï¼ˆå¤ä»å®‡ï¼‰" }]
    },
    wishes: [
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næŠŠå¿ƒäº‹äº¤ç»™æœˆå…‰\næŠŠç›®æ ‡äº¤ç»™ä»Šå¤©\næŠŠç»“æœäº¤ç»™æ—¶é—´\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æ¥å¾—å¾ˆå…·ä½“ï¼š\n\nå¥½æœºä¼šã€å¥½çŠ¶æ€ã€å¥½å¿ƒæƒ…\nå…¨éƒ½åœ¨è·¯ä¸Šã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ä¸‡äº‹é¡ºæ„\n- å¥½è¿å¸¸åœ¨\n\nâ€”â€” ${f}`
  },
};

/** ----------------------------
 * Optional: ä¸“å±é“¾æ¥æ¨¡å¼ ?k=xxx
 * ---------------------------- */
const KEY_TO_BDAY = {
  steven: "20050309",
  cici: "20040210",
  manda: "20040611",
  michelle: "20040510",
  ge: "20030717",
  yangxu: "20041105",
  dad: "19800806",
  mom: "19791120",
  xiarenyu: "20050401",
};

const personKey = (qs.get("k") || "").trim().toLowerCase();
const forcedBday = KEY_TO_BDAY[personKey] || "";
const forcedProfile = forcedBday ? PEOPLE_BY_BDAY[forcedBday] : null;

setActiveTZ(forcedProfile?.tz || TZ_BJ);
updateVideoGate(false);

/** ----------------------------
 * Lock / input restriction
 * ---------------------------- */
const lockEl = document.getElementById("lock");
const passInput = document.getElementById("passInput");
const unlockBtn = document.getElementById("unlockBtn");
const lockErr = document.getElementById("lockErr");

const lockedButtons = [openBtn, newWishBtn, giftBtn, copyBtn, boomBtn];
lockedButtons.forEach(b => b.disabled = true);

let unlocked = false;
let pendingNewYear = false;

let resolvedName = "ä½ ";
let activeProfile = null;

function normalizeBirthday(input){
  return String(input || "").trim().replace(/\D/g, "");
}
function setHint(msg){ lockErr.textContent = msg || ""; }
function applyName(name){
  resolvedName = name;
  const el = document.getElementById("toName");
  if (el) el.textContent = name;
}

/** ----------------------------
 * âœ… è§£é”åï¼šæ–°å¹´å¿«ä¹ + ç¤¼èŠ±å½©çº¸ UI
 * ---------------------------- */
const celebrateEl = document.getElementById("celebrate");
const confettiEl = document.getElementById("confetti");
const celebrateTitle = document.getElementById("celebrateTitle");
const celebrateSub = document.getElementById("celebrateSub");

function showCelebration(){
  celebrateTitle.textContent = `ğŸ‰ æ–°å¹´å¿«ä¹ï¼Œ${resolvedName}ï¼`;
  celebrateSub.textContent = "è§£é”æˆåŠŸï½";

  confettiEl.innerHTML = "";
  const colors = ["#ff3b3b", "#ffd36e", "#ff77a8", "#ffffff"];
  const N = 90;
  for(let i=0;i<N;i++){
    const p = document.createElement("i");
    const left = Math.random() * 100;
    const dx = (Math.random()*2 - 1) * 120;
    const dur = 1.2 + Math.random() * 1.1;
    const delay = Math.random() * 0.25;
    const c = colors[Math.floor(Math.random()*colors.length)];
    const w = 6 + Math.random()*8;
    const h = 10 + Math.random()*14;

    p.style.left = left + "vw";
    p.style.setProperty("--dx", dx + "px");
    p.style.setProperty("--dur", dur + "s");
    p.style.setProperty("--delay", delay + "s");
    p.style.setProperty("--c", c);
    p.style.width = w + "px";
    p.style.height = h + "px";
    confettiEl.appendChild(p);
  }

  celebrateEl.classList.add("show");
  burst(10);

  setTimeout(()=>{
    celebrateEl.classList.remove("show");
    confettiEl.innerHTML = "";
  }, 1400);
}

function typeOut(text){
  if(window.__typingTimer) clearInterval(window.__typingTimer);
  typedEl.textContent = "";
  let i = 0;
  window.__typingTimer = setInterval(()=>{
    typedEl.textContent += text[i++] || "";
    if(i > text.length) clearInterval(window.__typingTimer);
  }, 18);
}

function pickWish(){
  const fallback = [
    (n,y,f)=>`ğŸ§§ ${n}ï¼Œæå‰ç¥ä½  ${y} æ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ ï¼š\n1) æœ‰æ›´è‡ªç”±çš„é€‰æ‹©\n2) æœ‰æ›´ç¨³å®šçš„å†…æ ¸\n3) æœ‰æ›´æ¸©æŸ”çš„å¥½è¿\n\nâ€”â€” ${f}`,
    (n,y,f)=>`âœ¨ ${n}ï¼Œ${y}\n\nå…è®¸è‡ªå·±æ…¢ä¸€ç‚¹\nå…è®¸å¶å°”ä¸å®Œç¾\nå…è®¸è¢«çˆ±ã€è¢«æ”¯æŒ\n\nâ€”â€” ${f}`,
    (n,y,f)=>`ğŸ† ${n}ï¼Œ${y} ç»™ä½ ä¸€ä¸ªå¾ˆå…·ä½“çš„ç¥ç¦ï¼š\n\nåƒé¥­å¥½å¥½åƒ\nç¡è§‰å¥½å¥½ç¡\néš¾é¢˜ä¸€ç‚¹ç‚¹è§£\nå¥½è¿ä¸€ç‚¹ç‚¹æ¥\n\nâ€”â€” ${f}`,
  ];
  const list = (activeProfile && activeProfile.wishes && activeProfile.wishes.length)
    ? activeProfile.wishes
    : fallback;
  return list[Math.floor(Math.random() * list.length)];
}
function newWish(){
  const f = pickWish();
  typeOut(f(resolvedName, GIFT_YEAR, from));
}
function showNewYearMessage(){
  const txt = (activeProfile && activeProfile.newYear)
    ? activeProfile.newYear(resolvedName, GIFT_YEAR, from)
    : `ğŸ‰ ${resolvedName}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${GIFT_YEAR}ï¼š\n- ç”Ÿæ´»æœ‰å…‰\n- ç›®æ ‡æœ‰è·¯\n- æƒ…ç»ªæœ‰å‡ºå£\n- å¿ƒé‡Œæ›´æ¾ä¸€ç‚¹\n\nâ€”â€” ${from}`;

  typeOut(txt);
  document.getElementById("extra").classList.remove("hidden");
  burst(8);
}

function afterUnlock(){
  unlocked = true;
  lockEl.style.display = "none";
  lockedButtons.forEach(b => b.disabled = false);

  setActiveTZ(activeProfile?.tz || TZ_BJ);

  showCelebration();
  document.getElementById("extra").classList.remove("hidden");
  burst(3);

  updateVideoGate(true);

  if (Date.now() >= openAtEpoch) {
    showNewYearMessage();
    reachedNewYear = true;
  } else {
    newWish();
  }
}

/** è¾“å…¥é™åˆ¶ */
passInput.addEventListener("input", () => {
  let v = passInput.value.replace(/\D/g, "");
  if (v.length > 8) v = v.slice(0, 8);
  if (passInput.value !== v) passInput.value = v;

  if (forcedProfile) {
    if (v.length === 0) setHint(`æ­¤é“¾æ¥å±äºã€Œ${forcedProfile.name}ã€ï¼Œè¯·è¾“å…¥ TA çš„ 8 ä½ç”Ÿæ—¥`);
    else if (v.length < 8) setHint(`è¿˜å·® ${8 - v.length} ä½`);
    else setHint("å·²è¾“å…¥ 8 ä½ âœ… å¯ä»¥è§£é”");
  } else {
    if (v.length === 0) setHint("è¯·è¾“å…¥ 8 ä½ç”Ÿæ—¥ï¼šYYYYMMDD");
    else if (v.length < 8) setHint(`è¿˜å·® ${8 - v.length} ä½`);
    else setHint("å·²è¾“å…¥ 8 ä½ âœ… å¯ä»¥è§£é”");
  }
});

if (forcedProfile) setHint(`æ­¤é“¾æ¥å±äºã€Œ${forcedProfile.name}ã€ï¼Œè¯·è¾“å…¥ TA çš„ 8 ä½ç”Ÿæ—¥`);
else setHint("è¯·è¾“å…¥ 8 ä½ç”Ÿæ—¥ï¼šYYYYMMDD");

function tryUnlock(){
  lockErr.textContent = "";
  const normalized = normalizeBirthday(passInput.value);

  if (normalized.length !== 8) {
    lockErr.textContent = "æ ¼å¼ä¸å¯¹ï¼šè¯·è¾“å…¥ 8 ä½ YYYYMMDDï¼ˆä¾‹å¦‚ 20050309ï¼‰";
    return;
  }

  if (forcedProfile) {
    if (normalized !== forcedBday) {
      lockErr.textContent = "ç”Ÿæ—¥ä¸åŒ¹é…è¿™ä¸ªä¸“å±é“¾æ¥ï¼Œå†è¯•ä¸€æ¬¡ï½";
      passInput.select();
      return;
    }
    activeProfile = forcedProfile;
    applyName(activeProfile.name);
    afterUnlock();
    return;
  }

  const profile = PEOPLE_BY_BDAY[normalized];
  if (!profile) {
    lockErr.textContent = "è¿™ä¸ªç”Ÿæ—¥ä¸åœ¨åå•é‡Œï¼ˆæˆ–ä½ è¾“é”™äº†ï¼‰ï¼Œå†è¯•ä¸€æ¬¡ï½";
    passInput.select();
    return;
  }

  activeProfile = profile;
  applyName(profile.name);
  afterUnlock();
}

unlockBtn.addEventListener("click", tryUnlock);
passInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryUnlock(); });

/** Buttons */
newWishBtn.addEventListener("click", ()=>{
  if (!unlocked) return;
  newWish();
  burst(3);
});
boomBtn.addEventListener("click", ()=>{
  if (!unlocked) return;
  burst(7);
});

/** Copy link */
copyBtn.addEventListener("click", async ()=>{
  const url = new URL(location.href);
  url.searchParams.set("from", from);

  if (forcedProfile) url.searchParams.set("k", personKey);
  else url.searchParams.delete("k");

  try{
    await navigator.clipboard.writeText(url.toString());
    showToast(forcedProfile ? "å·²å¤åˆ¶ä¸“å±é“¾æ¥ âœ…" : "å·²å¤åˆ¶é€šç”¨é“¾æ¥ âœ…");
  }catch(e){
    showToast("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€æ ");
  }
});

/** Gift Photo Modal */
const giftModal = document.getElementById("giftModal");
const closeGiftBtn = document.getElementById("closeGiftBtn");
const giftImgGrid = document.getElementById("giftImgGrid");
const giftModalTitle = document.getElementById("giftModalTitle");
const giftHint = document.getElementById("giftHint");

function openGiftModal(){
  if (!unlocked || !activeProfile) { showToast("å…ˆè§£é”å†æ‰“å¼€ç¤¼ç‰©å“¦ï½"); return; }
  const gift = activeProfile.gift || null;

  giftModalTitle.textContent = gift?.title || "ğŸ ç¤¼ç‰©ç…§ç‰‡";
  giftHint.textContent = gift?.hint || "";
  giftImgGrid.innerHTML = "";

  const imgs = gift?.images || [];
  if (!imgs.length){
    giftImgGrid.innerHTML = `<div style="color:var(--muted);font-size:13px;line-height:1.7;">
      æ²¡æœ‰é…ç½®å›¾ç‰‡ã€‚è¯·åœ¨ PEOPLE_BY_BDAY é‡Œç»™è¿™ä¸ªäººåŠ ä¸Š gift.images çš„è·¯å¾„ã€‚
    </div>`;
  }else{
    imgs.forEach(item=>{
      const card = document.createElement("div");
      card.className = "imgCard";
      card.innerHTML = `
        <img src="${item.src}" alt="${item.caption || "gift image"}" loading="lazy" />
        <div class="imgCap">${item.caption || ""}</div>
      `;
      giftImgGrid.appendChild(card);
    });
  }

  giftModal.classList.remove("hidden");
  giftModal.setAttribute("aria-hidden", "false");
}
function closeGiftModal(){
  giftModal.classList.add("hidden");
  giftModal.setAttribute("aria-hidden", "true");
}
giftBtn.addEventListener("click", openGiftModal);
closeGiftBtn.addEventListener("click", closeGiftModal);
giftModal.addEventListener("click", (e)=>{ if (e.target === giftModal) closeGiftModal(); });

/** Video Gift Modal + åˆ°ç‚¹æ‰å¯æ‰“å¼€ */
const videoModal = document.getElementById("videoModal");
const closeVideoBtn = document.getElementById("closeVideoBtn");
const videoModalTitle = document.getElementById("videoModalTitle");
const giftVideo = document.getElementById("giftVideo");

function openVideoModal(){
  if (!unlocked || !activeProfile) { showToast("å…ˆè§£é”å†æ‹†ç¤¼ç‰©å“¦ï½"); return; }
  if (Date.now() < openAtEpoch){
    showToast(`è¿˜æ²¡åˆ° ${GIFT_YEAR} 00:00ï¼ˆ${tzLabel(activeTZ)}ï¼‰ï¼Œå†ç­‰ç­‰ï½`);
    return;
  }
  const src = activeProfile.video || "";
  if (!src) { showToast("è¿™ä¸ªäººè¿˜æ²¡é…ç½®è§†é¢‘ï½"); return; }

  videoModalTitle.textContent = `ğŸ¥ ${resolvedName} çš„è§†é¢‘ç¤¼ç‰©`;
  giftVideo.pause();
  giftVideo.src = src;
  giftVideo.currentTime = 0;

  videoModal.classList.remove("hidden");
  videoModal.setAttribute("aria-hidden", "false");

  const p = giftVideo.play();
  if (p && typeof p.catch === "function") p.catch(()=>{});
  burst(6);
}
function closeVideoModal(){
  giftVideo.pause();
  giftVideo.removeAttribute("src");
  giftVideo.load();
  videoModal.classList.add("hidden");
  videoModal.setAttribute("aria-hidden", "true");
}
openBtn.addEventListener("click", openVideoModal);
closeVideoBtn.addEventListener("click", closeVideoModal);
videoModal.addEventListener("click", (e)=>{ if (e.target === videoModal) closeVideoModal(); });

/** ESC å…³é—­å¼¹çª— */
addEventListener("keydown", (e)=>{
  if (e.key === "Escape") {
    if (!giftModal.classList.contains("hidden")) closeGiftModal();
    if (!videoModal.classList.contains("hidden")) closeVideoModal();
  }
});

/** Countdown tick */
function tick(){
  const t = openAtEpoch - Date.now();
  const done = t <= 0;
  const total = Math.max(0, t);

  const sec = Math.floor(total / 1000);
  const days = Math.floor(sec / 86400);
  const hours = Math.floor((sec % 86400) / 3600);
  const mins = Math.floor((sec % 3600) / 60);
  const secs = sec % 60;

  dd.textContent = pad(days);
  hh.textContent = pad(hours);
  mm.textContent = pad(mins);
  ss.textContent = pad(secs);

  if(done && !reachedNewYear){
    reachedNewYear = true;
    if (unlocked) showNewYearMessage();
    else pendingNewYear = true;
  }

  updateVideoGate(unlocked);
}
setInterval(tick, 200);
tick();
</script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ New Year Gift</title>
  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0B1630;
      --card:#0e1b33cc;
      --line:#ffffff24;
      --text:#eaf2ff;
      --muted:#b9c7e6;
      --accent:#7cf7ff;
      --accent2:#ff77e1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial;
      color:var(--text);
      background: radial-gradient(900px 600px at 20% 10%, #182a55 0%, transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, #3a1247 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    canvas#fx{
      position:fixed; inset:0; width:100%; height:100%;
      pointer-events:none; z-index:1;
    }
    .wrap{
      position:relative; z-index:2;
      max-width:920px; margin:0 auto; padding:40px 18px 64px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:16px;
    }
    .badge{
      display:inline-flex; gap:10px; align-items:center;
      border:1px solid var(--line); border-radius:999px;
      padding:8px 12px; background:#ffffff0f; backdrop-filter: blur(10px);
      font-size:14px; color:var(--muted);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, var(--accent), #0ff0);
      box-shadow: 0 0 14px var(--accent);
    }
    .card{
      border:1px solid var(--line);
      border-radius:22px;
      background: linear-gradient(135deg,#ffffff14,#ffffff06);
      box-shadow: 0 20px 60px #00000055;
      overflow:hidden;
    }
    .hero{
      padding:28px 22px 18px;
      background: radial-gradient(900px 260px at 10% 10%, #7cf7ff22, transparent 60%),
                  radial-gradient(900px 260px at 90% 10%, #ff77e122, transparent 60%);
      border-bottom:1px solid var(--line);
    }
    h1{
      margin:0;
      font-size:28px;
      letter-spacing:.5px;
      line-height:1.2;
    }
    .sub{
      margin:10px 0 0;
      color:var(--muted);
      font-size:15px;
      line-height:1.7;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .8fr;
      padding:18px 22px 22px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
      padding:16px;
    }
    .kpi{
      display:grid; grid-template-columns: repeat(4,1fr);
      gap:10px; margin-top:10px;
    }
    @media (max-width: 520px){
      .kpi{grid-template-columns: repeat(2,1fr)}
    }
    .k{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 10px;
      text-align:center;
      background:#ffffff08;
    }
    .k b{display:block; font-size:22px}
    .k span{display:block; margin-top:6px; color:var(--muted); font-size:12px}
    .btns{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button{
      border:1px solid var(--line);
      background:#ffffff10;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:14px;
      transition: transform .08s ease, background .2s ease;
    }
    button:hover{background:#ffffff16}
    button:active{transform: translateY(1px)}
    .primary{
      border-color:#7cf7ff55;
      background: linear-gradient(90deg,#7cf7ff22,#ff77e122);
      box-shadow: 0 0 0 1px #7cf7ff22 inset;
    }
    .msg{
      margin:0;
      white-space:pre-wrap;
      line-height:1.75;
      font-size:15px;
    }
    .type{
      display:inline-block;
      border-right: 2px solid #ffffff66;
      padding-right:2px;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 50%{border-right-color: transparent} }
    .small{color:var(--muted); font-size:12px; margin-top:10px}
    .footer{
      padding:14px 22px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      color:var(--muted); font-size:12px;
    }
    a{color:var(--accent)}
    .hidden{display:none}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 12px; border-radius:14px;
      background:#000000aa; color:#fff; font-size:13px;
      border:1px solid #ffffff2a; z-index:5;
      opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    .toast.show{opacity:1}
    @media (prefers-reduced-motion: reduce){
      canvas#fx{display:none}
      .type{animation:none; border-right:none}
      button{transition:none}
    }

    /* ===== Password lock UI ===== */
    button:disabled{opacity:.55; cursor:not-allowed}

    .lock{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      padding:20px;
      background: radial-gradient(800px 500px at 50% 20%, #ffffff14, transparent 60%),
                rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .lockCard{
      width:min(520px, 100%);
      border:1px solid #ffffff2a;
      border-radius:22px;
      padding:18px 16px 14px;
      background: linear-gradient(135deg, #0e1b33ee, #0b1326ee);
      box-shadow: 0 30px 90px #00000088;
    }
    .lockTitle{font-size:18px; margin:0 0 6px}
    .lockSub{margin:0 0 14px; color:#b9c7e6; font-size:13px; line-height:1.6}
    .lockRow{display:flex; gap:10px}
    .lockRow input{
      flex:1; padding:10px 12px; border-radius:14px;
      border:1px solid #ffffff2a; background:#ffffff0a;
      color:#eaf2ff; outline:none;
    }
    .lockRow input:focus{border-color:#7cf7ff55}
    .lockErr{margin:10px 0 0; color:#ffb2d8; font-size:12px; min-height:16px}
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="top">
      <div class="badge"><span class="dot"></span><span id="meta">Loadingâ€¦</span></div>
      <div class="badge">ğŸ† ä»£ç å°ç¤¼ç‰©</div>
    </div>

    <div class="card">
      <div class="hero">
        <h1 id="title">ç»™ <span id="toName">ä½ </span> çš„è·¨å¹´ç¤¼ç‰©</h1>
        <p class="sub" id="subText">
          è¾“å…¥ä½ çš„ç”Ÿæ—¥ï¼ˆYYYYMMDDï¼‰è§£é”ã€‚<br/>
          ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ æƒ³ç»™æ¯ä¸ªäººä¸€ä¸ªâ€œä¸“å±é“¾æ¥â€ï¼Œç”¨ ?k=cici è¿™ç§æ–¹å¼ã€‚
        </p>
      </div>

      <div class="grid">
        <div class="panel">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
            <div>
              <div style="color:var(--muted);font-size:13px">è·ç¦»æ–°å¹´çš„æ—¶é—´</div>
              <div class="kpi" aria-label="countdown">
                <div class="k"><b id="dd">--</b><span>å¤©</span></div>
                <div class="k"><b id="hh">--</b><span>å°æ—¶</span></div>
                <div class="k"><b id="mm">--</b><span>åˆ†é’Ÿ</span></div>
                <div class="k"><b id="ss">--</b><span>ç§’</span></div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted);font-size:12px">From</div>
              <div style="font-size:14px;margin-top:6px" id="fromName">Steven</div>
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="openBtn">ğŸ ç°åœ¨æ‹†ç¤¼ç‰©</button>
            <button id="newWishBtn">âœ¨ æ¢ä¸€å¥ç¥ç¦</button>
            <button id="copyBtn">ğŸ”— å¤åˆ¶é“¾æ¥</button>
            <button id="boomBtn">ğŸ† æ”¾ä¸€æ¬¡çƒŸèŠ±</button>
          </div>

          <p class="small" id="smallNote">
            è¯´æ˜ï¼šä½ å¯ä»¥å‘åŒä¸€ä¸ªé“¾æ¥ç»™æ‰€æœ‰äººï¼ˆä¸éœ€è¦ to å‚æ•°ï¼‰ã€‚<br/>
            è¾“å…¥ç”Ÿæ—¥åï¼Œé¡µé¢ä¼šè‡ªåŠ¨æ˜¾ç¤ºå¯¹åº”åå­—ï¼Œå¹¶æ˜¾ç¤ºâ€œå±äºè¿™ä¸ªäººâ€çš„ç¥ç¦å†…å®¹ã€‚
          </p>
        </div>

        <div class="panel">
          <div style="color:var(--muted);font-size:13px;margin-bottom:10px">ç¤¼ç‰©å†…å®¹</div>
          <p class="msg" id="msg">
            <span id="typed" class="type">ğŸ”’ è¾“å…¥ç”Ÿæ—¥è§£é”åå¯è§</span>
          </p>
          <div id="extra" class="hidden" style="margin-top:12px; border-top:1px solid var(--line); padding-top:12px;">
            <div style="color:var(--muted);font-size:12px">ğŸ¯ æ–°å¹´å°ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰</div>
            <ul style="margin:8px 0 0; padding-left:18px; line-height:1.7;">
              <li>é€‰ä¸€ä¸ªä½ æƒ³åšæŒçš„ä¹ æƒ¯ï¼ŒåšæŒ 7 å¤©ã€‚</li>
              <li>æŠŠè¿™ä¸€é¡µè½¬å‘ç»™ 1 ä¸ªä½ åœ¨ä¹çš„äººã€‚</li>
              <li>ç»™è‡ªå·±å†™ä¸€å¥â€œæ˜å¹´æˆ‘å¸Œæœ›ä½ ___â€ã€‚</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Made By Yuxuan Lin</div>
        <div>Tip: éƒ¨ç½²åˆ° GitHub Pages ä½“éªŒæœ€ä½³</div>
      </div>
    </div>
  </div>

  <!-- Password Lock -->
  <div class="lock" id="lock">
    <div class="lockCard">
      <p class="lockTitle">ğŸ”’ è¾“å…¥ä½ çš„ç”Ÿæ—¥æ¥æ‹†ç¤¼ç‰©</p>
      <p class="lockSub" id="lockHint">è¯·è¾“å…¥ 8 ä½æ•°å­—ï¼šYYYYMMDDï¼ˆä¾‹å¦‚ 19990506ï¼‰</p>

      <div class="lockRow">
        <input
          id="passInput"
          type="password"
          inputmode="numeric"
          autocomplete="off"
          placeholder="YYYYMMDD"
          maxlength="8"
          pattern="\d{8}"
        />
        <button class="primary" id="unlockBtn">è§£é”</button>
      </div>
      <div class="lockErr" id="lockErr"></div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å¤åˆ¶</div>

<script>
/** ----------------------------
 * URL params:
 *   ?from=Name (optional)
 *   ?k=personKey (optional: ä¸“å±é“¾æ¥æ¨¡å¼)
 * ---------------------------- */
const qs = new URLSearchParams(location.search);
const from = (qs.get("from") || "Steven").trim().slice(0, 24);
document.getElementById("fromName").textContent = from;

// DOM refs
const typedEl = document.getElementById("typed");
const openBtn = document.getElementById("openBtn");
const newWishBtn = document.getElementById("newWishBtn");
const copyBtn = document.getElementById("copyBtn");
const boomBtn = document.getElementById("boomBtn");
const dd = document.getElementById("dd");
const hh = document.getElementById("hh");
const mm = document.getElementById("mm");
const ss = document.getElementById("ss");

/** ----------------------------
 * Countdown
 * ---------------------------- */
const now = new Date();
const nextYear = now.getFullYear() + 1;
const target = new Date(nextYear, 0, 1, 0, 0, 0);
document.getElementById("meta").textContent =
  `ç°åœ¨æ˜¯ ${now.toLocaleString()} Â· ç›®æ ‡ï¼š${target.toLocaleString()}`;

function pad(n){ return String(n).padStart(2,"0"); }

/** ----------------------------
 * Fireworks
 * ---------------------------- */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d");
let W=0,H=0, DPR=1;

function resize(){
  DPR = Math.min(2, window.devicePixelRatio || 1);
  W = canvas.width = Math.floor(innerWidth * DPR);
  H = canvas.height = Math.floor(innerHeight * DPR);
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
}
addEventListener("resize", resize);
resize();

const particles = [];
function rand(a,b){ return a + Math.random()*(b-a); }

function launch(x, y){
  const count = Math.floor(rand(60, 110));
  for(let i=0;i<count;i++){
    const ang = rand(0, Math.PI*2);
    const spd = rand(1.0, 5.2) * DPR;
    particles.push({
      x, y,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      life: rand(40, 90),
      age: 0,
      hue: rand(160, 330)
    });
  }
}

function burst(times=5){
  for(let i=0;i<times;i++){
    const x = rand(W*0.15, W*0.85);
    const y = rand(H*0.15, H*0.55);
    launch(x,y);
  }
}

function step(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.fillRect(0,0,W,H);

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.age++;
    const t = p.age / p.life;
    p.vx *= 0.988;
    p.vy = p.vy*0.988 + 0.03*DPR;
    p.x += p.vx;
    p.y += p.vy;

    const alpha = Math.max(0, 1 - t);
    ctx.beginPath();
    ctx.fillStyle = `hsla(${p.hue},100%,70%,${alpha})`;
    ctx.arc(p.x, p.y, Math.max(1.0, 2.0*(1-t))*DPR, 0, Math.PI*2);
    ctx.fill();

    if(p.age >= p.life) particles.splice(i,1);
  }
  requestAnimationFrame(step);
}
step();

/** ----------------------------
 * Toast
 * ---------------------------- */
const toast = document.getElementById("toast");
function showToast(txt){
  toast.textContent = txt;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 900);
}

/** ----------------------------
 * Per-person data (æ¯ä¸ªäººç‹¬ç«‹å†…å®¹)
 * ä½ åªè¦æ”¹è¿™é‡Œï¼šbirthday / name / wishes / newYear
 * ---------------------------- */
const PEOPLE_BY_BDAY = {
  "20050309": {
    name: "Steven",
    wishes: [
      (n,y,f)=>`ğŸ ${n}ï¼Œ${y} é€ä½ ä¸€å¥æœ€é‡è¦çš„ï¼š\n\nåˆ«æŠŠæ‰€æœ‰äº‹éƒ½ä¸€ä¸ªäººæ‰›ã€‚\nä½ å¯ä»¥å¼ºï¼Œä½†ä¹Ÿå€¼å¾—è¢«ç…§é¡¾ã€‚\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œ${y} æƒ³é€ä½ ä¸€ç§â€œæ¾å¼›â€ï¼š\n\næŠŠç„¦è™‘äº¤ç»™è¡ŒåŠ¨\næŠŠç›®æ ‡æ‹†æˆä»Šå¤©\næŠŠè‡ªå·±å½“æˆé˜Ÿå‹\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æŒ‡ä»¤å·²ä¸‹å‘ï¼š\n\nif (ä½ å…ˆç…§é¡¾å¥½è‡ªå·±) {\n  å¥½è¿++; \n}\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ç”Ÿæ´»æœ‰å…‰\n- ä»£ç é¡ºæ»‘\n- ç¡çœ å®‰ç¨³\n- å¿ƒé‡Œæ›´æ¾ä¸€ç‚¹\n\nâ€”â€” ${f}`
  },
  "20040210": {
    name: "CiCi",
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç»™ä½ ä¸‰å¥â€œæ”¾å¿ƒâ€ï¼š\n\næ”¾å¿ƒå»å°è¯•\næ”¾å¿ƒå»å‘å…‰\næ”¾å¿ƒå»è¢«çˆ±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`âœ¨ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\né‡åˆ°å¥½äºº\nåšæˆå¥½äº‹\nå¾—åˆ°å¥½æ¶ˆæ¯\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- äº‹äº‹é¡ºæ„\n- å¥½è¿å¸¸åœ¨\n- å¼€å¿ƒæ›´ä¹…\n\nâ€”â€” ${f}`
  },
  "20040611": {
    name: "Manda",
    wishes: [
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næŠŠçƒ­çˆ±å˜æˆä½œå“\næŠŠåŠªåŠ›å˜æˆç»“æœ\næŠŠæ¸©æŸ”ç•™ç»™è‡ªå·±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œ${y} é€ä½ ä¸€ä¸ªç¥ç¦ï¼š\n\nä½ å€¼å¾—è¢«è®¤çœŸå¯¹å¾…ã€‚\næ¯ä¸€æ­¥éƒ½ç®—æ•°ã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- å¹³å®‰å–œä¹\n- å¿ƒæƒ³äº‹æˆ\n\nâ€”â€” ${f}`
  },
  "20040510": {
    name: "Michelle",
    wishes: [
      (n,y,f)=>`âœ¨ ${n}ï¼Œ${y} é€ä½ ä¸‰ä¸ªâ€œå…è®¸â€ï¼š\n\nå…è®¸è‡ªå·±æ…¢ä¸€ç‚¹\nå…è®¸å¶å°”ä¸å®Œç¾\nå…è®¸è¢«çˆ±ã€è¢«æ”¯æŒ\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næ›´æ¸…é†’ï¼Œä¹Ÿæ›´æŸ”è½¯\næ›´åšå®šï¼Œä¹Ÿæ›´è½»æ¾\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- æ¸©æŸ”åšå®š\n- å¥½è¿åŠ å€\n\nâ€”â€” ${f}`
  },
  "20030717": {
    name: "å“¥",
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥ä½ ï¼š\n\né¡ºé£é¡ºæ°´\nå‘è´¢å‘ç¦ï¼ˆä¹Ÿåˆ«å¤ªç´¯ï¼‰\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\nå°‘ä¸€ç‚¹çƒ¦å¿ƒäº‹\nå¤šä¸€ç‚¹å¥½æ¶ˆæ¯\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- äº‹ä¸šé¡ºåˆ©\n- å®¶é‡Œå¹³å®‰\n\nâ€”â€” ${f}`
  },
  "20041105": {
    name: "æ¨æ—­",
    wishes: [
      (n,y,f)=>`âœ¨ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\nä¸€ç›´æœ‰åº•æ°”\nä¸€ç›´æœ‰é€‰æ‹©\nä¸€ç›´æœ‰çƒ­çˆ±\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æŒ‡ä»¤ï¼š\n\nä¿æŒä½ çš„èŠ‚å¥ã€‚\nä½ ä¼šè¶Šèµ°è¶Šç¨³ã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ä¸€è·¯å¼€æŒ‚\n- å¿ƒæƒ…è½»æ¾\n\nâ€”â€” ${f}`
  },
  "19800806": {
    name: "çˆ¸",
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥æ‚¨ï¼š\n\nèº«ä½“å¥åº·\näº‹äº‹é¡ºå¿ƒ\nå¤©å¤©å¼€å¿ƒ\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿æ‚¨ ${y}ï¼š\n\nå°‘æ“å¿ƒï¼Œå¤šä¼‘æ¯\nå¹³å¹³å®‰å®‰ï¼Œé¡ºé¡ºåˆ©åˆ©\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿æ‚¨åœ¨ ${y}ï¼š\n- å¹³å®‰å¥åº·\n- ç¦æ°”æ»¡æ»¡\n\nâ€”â€” ${f}`
  },
  "19791120": {
    name: "å¦ˆ",
    wishes: [
      (n,y,f)=>`ğŸ§§ ${n}ï¼Œ${y} ç¥æ‚¨ï¼š\n\nèº«ä½“å¥åº·\nç¬‘å£å¸¸å¼€\nä¸‡äº‹å¦‚æ„\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ ${n}ï¼Œæ„¿æ‚¨ ${y}ï¼š\n\nå°‘çƒ¦æ¼ï¼Œå¤šå¼€å¿ƒ\næ¯å¤©éƒ½è½»è½»æ¾æ¾\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿æ‚¨åœ¨ ${y}ï¼š\n- å¥åº·å¹³å®‰\n- å¼€å¼€å¿ƒå¿ƒ\n\nâ€”â€” ${f}`
  },
  "20050401": {
    name: "å¤ä»å®‡",
    wishes: [
      (n,y,f)=>`ğŸŒ™ ${n}ï¼Œæ„¿ä½  ${y}ï¼š\n\næŠŠå¿ƒäº‹äº¤ç»™æœˆå…‰\næŠŠç›®æ ‡äº¤ç»™ä»Šå¤©\næŠŠç»“æœäº¤ç»™æ—¶é—´\n\nâ€”â€” ${f}`,
      (n,y,f)=>`ğŸ‡ ${n}ï¼Œå¥½è¿æ¥å¾—å¾ˆå…·ä½“ï¼š\n\nå¥½æœºä¼šã€å¥½çŠ¶æ€ã€å¥½å¿ƒæƒ…\nå…¨éƒ½åœ¨è·¯ä¸Šã€‚\n\nâ€”â€” ${f}`
    ],
    newYear: (n,y,f)=>`ğŸ‰ ${n}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${y}ï¼š\n- ä¸‡äº‹é¡ºæ„\n- å¥½è¿å¸¸åœ¨\n\nâ€”â€” ${f}`
  },
};

/** ----------------------------
 * Optional: ä¸“å±é“¾æ¥æ¨¡å¼ ?k=xxx
 * ä¾‹ï¼š?k=cici åªèƒ½ç”¨ cici çš„ç”Ÿæ—¥è§£é”
 * ---------------------------- */
const KEY_TO_BDAY = {
  steven: "20050309",
  cici: "20040210",
  manda: "20040611",
  michelle: "20040510",
  ge: "20030717",
  yangxu: "20041105",
  dad: "19800806",
  mom: "19791120",
  xiarenyu: "20050401",
};

const personKey = (qs.get("k") || "").trim().toLowerCase();
const forcedBday = KEY_TO_BDAY[personKey] || "";
const forcedProfile = forcedBday ? PEOPLE_BY_BDAY[forcedBday] : null;

/** ----------------------------
 * Lock / input restriction
 * ---------------------------- */
const lockEl = document.getElementById("lock");
const passInput = document.getElementById("passInput");
const unlockBtn = document.getElementById("unlockBtn");
const lockErr = document.getElementById("lockErr");

const lockedButtons = [openBtn, newWishBtn, copyBtn, boomBtn];
lockedButtons.forEach(b => b.disabled = true);

let unlocked = false;
let pendingNewYear = false;

let resolvedName = "ä½ ";
let activeProfile = null;

function normalizeBirthday(input){
  return String(input || "").trim().replace(/\D/g, "");
}

function setHint(msg){ lockErr.textContent = msg || ""; }

function applyName(name){
  resolvedName = name;
  const el = document.getElementById("toName");
  if (el) el.textContent = name;
}

function typeOut(text){
  if(window.__typingTimer) clearInterval(window.__typingTimer);
  typedEl.textContent = "";
  let i = 0;
  window.__typingTimer = setInterval(()=>{
    typedEl.textContent += text[i++] || "";
    if(i > text.length) clearInterval(window.__typingTimer);
  }, 18);
}

function pickWish(){
  const list = (activeProfile && activeProfile.wishes && activeProfile.wishes.length)
    ? activeProfile.wishes
    : [
        (n,y,f)=>`ğŸ ${n}ï¼Œæå‰ç¥ä½  ${y} æ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ ï¼š\n1) æœ‰æ›´è‡ªç”±çš„é€‰æ‹©\n2) æœ‰æ›´ç¨³å®šçš„å†…æ ¸\n3) æœ‰æ›´æ¸©æŸ”çš„å¥½è¿\n\nâ€”â€” ${f}`,
        (n,y,f)=>`âœ¨ ${n}ï¼Œ${y} é€ä½ ä¸‰ä¸ªâ€œå…è®¸â€ï¼š\n\nå…è®¸è‡ªå·±æ…¢ä¸€ç‚¹\nå…è®¸å¶å°”ä¸å®Œç¾\nå…è®¸è¢«çˆ±ã€è¢«æ”¯æŒ\n\nâ€”â€” ${f}`,
      ];
  return list[Math.floor(Math.random() * list.length)];
}

function newWish(){
  const f = pickWish();
  typeOut(f(resolvedName, nextYear, from));
}

function showNewYearMessage(){
  const txt = (activeProfile && activeProfile.newYear)
    ? activeProfile.newYear(resolvedName, nextYear, from)
    : `ğŸ‰ ${resolvedName}ï¼Œæ–°å¹´å¿«ä¹ï¼\n\næ„¿ä½ åœ¨ ${nextYear}ï¼š\n- ç”Ÿæ´»æœ‰å…‰\n- ä»£ç é¡ºæ»‘\n- ç¡çœ å®‰ç¨³\n- å¿ƒé‡Œæ›´æ¾ä¸€ç‚¹\n\nâ€”â€” ${from}`;
  typeOut(txt);
  document.getElementById("extra").classList.remove("hidden");
  burst(8);
}

function afterUnlock(){
  unlocked = true;
  lockEl.style.display = "none";
  lockedButtons.forEach(b => b.disabled = false);

  document.getElementById("extra").classList.remove("hidden");
  burst(3);

  if (pendingNewYear) {
    pendingNewYear = false;
    showNewYearMessage();
  } else {
    newWish();
  }
}

/** å®æ—¶è¾“å…¥é™åˆ¶ï¼šåªèƒ½æ•°å­— + æœ€å¤š8ä½ + æç¤º */
passInput.addEventListener("input", () => {
  let v = passInput.value.replace(/\D/g, "");
  if (v.length > 8) v = v.slice(0, 8);
  if (passInput.value !== v) passInput.value = v;

  if (forcedProfile) {
    if (v.length === 0) setHint(`æ­¤é“¾æ¥å±äºã€Œ${forcedProfile.name}ã€ï¼Œè¯·è¾“å…¥ TA çš„ 8 ä½ç”Ÿæ—¥`);
    else if (v.length < 8) setHint(`è¿˜å·® ${8 - v.length} ä½`);
    else setHint("å·²è¾“å…¥ 8 ä½ âœ… å¯ä»¥è§£é”");
  } else {
    if (v.length === 0) setHint("è¯·è¾“å…¥ 8 ä½ç”Ÿæ—¥ï¼šYYYYMMDD");
    else if (v.length < 8) setHint(`è¿˜å·® ${8 - v.length} ä½`);
    else setHint("å·²è¾“å…¥ 8 ä½ âœ… å¯ä»¥è§£é”");
  }
});

// åˆå§‹æç¤º
if (forcedProfile) setHint(`æ­¤é“¾æ¥å±äºã€Œ${forcedProfile.name}ã€ï¼Œè¯·è¾“å…¥ TA çš„ 8 ä½ç”Ÿæ—¥`);
else setHint("è¯·è¾“å…¥ 8 ä½ç”Ÿæ—¥ï¼šYYYYMMDD");

function tryUnlock(){
  lockErr.textContent = "";
  const normalized = normalizeBirthday(passInput.value);

  if (normalized.length !== 8) {
    lockErr.textContent = "æ ¼å¼ä¸å¯¹ï¼šè¯·è¾“å…¥ 8 ä½ YYYYMMDDï¼ˆä¾‹å¦‚ 19990506ï¼‰";
    return;
  }

  // ä¸“å±é“¾æ¥æ¨¡å¼ï¼šå¿…é¡»åŒ¹é…æŒ‡å®šç”Ÿæ—¥
  if (forcedProfile) {
    if (normalized !== forcedBday) {
      lockErr.textContent = "ç”Ÿæ—¥ä¸åŒ¹é…è¿™ä¸ªä¸“å±é“¾æ¥ï¼Œå†è¯•ä¸€æ¬¡ï½";
      passInput.select();
      return;
    }
    activeProfile = forcedProfile;
    applyName(activeProfile.name);
    afterUnlock();
    return;
  }

  // é€šç”¨æ¨¡å¼ï¼šç”¨ç”Ÿæ—¥æ‰¾äºº
  const profile = PEOPLE_BY_BDAY[normalized];
  if (!profile) {
    lockErr.textContent = "è¿™ä¸ªç”Ÿæ—¥ä¸åœ¨åå•é‡Œï¼ˆæˆ–ä½ è¾“é”™äº†ï¼‰ï¼Œå†è¯•ä¸€æ¬¡ï½";
    passInput.select();
    return;
  }

  activeProfile = profile;
  applyName(profile.name);
  afterUnlock();
}

unlockBtn.addEventListener("click", tryUnlock);
passInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryUnlock(); });

/** Buttons behavior (only after unlocked) */
openBtn.addEventListener("click", ()=>{
  if (!unlocked) return;
  newWish();
  burst(6);
});
newWishBtn.addEventListener("click", ()=>{
  if (!unlocked) return;
  newWish();
  burst(3);
});
boomBtn.addEventListener("click", ()=>{
  if (!unlocked) return;
  burst(7);
});

/** Copy link */
copyBtn.addEventListener("click", async ()=>{
  const url = new URL(location.href);
  url.searchParams.set("from", from);
  url.searchParams.delete("to");

  // å¦‚æœå½“å‰æ˜¯ä¸“å±é“¾æ¥æ¨¡å¼ï¼Œå°±ä¿ç•™ kï¼›å¦åˆ™åˆ é™¤ kï¼ˆåŒé“¾æ¥ç»™æ‰€æœ‰äººï¼‰
  if (forcedProfile) url.searchParams.set("k", personKey);
  else url.searchParams.delete("k");

  try{
    await navigator.clipboard.writeText(url.toString());
    showToast(forcedProfile ? "å·²å¤åˆ¶ä¸“å±é“¾æ¥ âœ…" : "å·²å¤åˆ¶é€šç”¨é“¾æ¥ âœ…");
  }catch(e){
    showToast("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€æ ");
  }
});

/** Countdown tick */
function tick(){
  const t = target.getTime() - Date.now();
  const done = t <= 0;
  const total = Math.max(0, t);

  const sec = Math.floor(total / 1000);
  const days = Math.floor(sec / 86400);
  const hours = Math.floor((sec % 86400) / 3600);
  const mins = Math.floor((sec % 3600) / 60);
  const secs = sec % 60;

  dd.textContent = pad(days);
  hh.textContent = pad(hours);
  mm.textContent = pad(mins);
  ss.textContent = pad(secs);

  if(done && !tick.fired){
    tick.fired = true;
    if (unlocked) showNewYearMessage();
    else pendingNewYear = true;
  }
}
setInterval(tick, 200);
tick();
</script>
</body>
</html>
